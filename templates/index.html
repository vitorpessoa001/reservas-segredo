<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Segredo da Colina üåø</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .dia.passado {
      background: #eee !important;
      color: #999 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
      border: 1px solid #ddd !important;
    }
    /* espa√ßamento suave entre legenda e texto */
    .legenda {
      margin-bottom: 18px;
    }
    #selecionado {
      margin-top: 10px;
      line-height: 1.6;
    }
    /* Estilos para sele√ß√£o visual */
    .dia.checkin {
      background: linear-gradient(135deg, transparent 49%, #6fb2f0 50%) #eaf9ea !important; /* De inferior esquerdo a superior direito */
      color: black !important;
    }
    .dia.checkout {
      background: linear-gradient(-45deg, transparent 49%, #6fb2f0 50%) #eaf9ea !important; /* De superior esquerdo a inferior direito */
      color: black !important;
    }
    .dia.range {
      background: #6fb2f0 !important;
      color: white !important;
    }
    /* Ajuste para evitar sobreposi√ß√£o de estilos */
    .dia.verde.checkin,
    .dia.verde.checkout,
    .dia.verde.range {
      border: 1px solid #ddd !important;
    }

  </style>
</head>

<body>
  <div class="container">
    <h1>Segredo da Colina üåø</h1>
    <p class="subtitle">Escolha o chal√© e verifique a disponibilidade</p>

    <div class="selectors">
      <button id="mesAnterior" class="arrow-btn">‚óÄ</button>
      <span id="mesAtual"></span>
      <button id="mesProximo" class="arrow-btn">‚ñ∂</button>
    </div>

    <div class="chale-pills">
      <button class="chale-pill active" data-chale="Chal√© 1">Chal√© 1</button>
      <button class="chale-pill" data-chale="Chal√© 2">Chal√© 2</button>
    </div>

    <div id="calendario">Carregando...</div>
    <div id="selecionado"></div>
  </div>

  <script>
  const calendario   = document.getElementById('calendario');
  const selecionado  = document.getElementById('selecionado');
  const mesAtualEl   = document.getElementById('mesAtual');
  const chalePills   = document.querySelectorAll('.chale-pill');

  let hoje = new Date();
  let ano  = hoje.getFullYear();
  let mes  = hoje.getMonth() + 1;
  let chaleSelecionado = "Chal√© 1";
  let checkIn = null;
  let checkOut = null;
  let diasGlobais = [];

  const meses = [
    "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  function localDateFromISO(iso) {
    const [y,m,d] = iso.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  chalePills.forEach(btn => {
    btn.addEventListener('click', () => {
      chalePills.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      chaleSelecionado = btn.dataset.chale;
      carregarCalendario();
    });
  });

  function atualizarMesTitulo() {
    mesAtualEl.textContent = `${meses[mes-1]} ${ano}`;
  }

  document.getElementById('mesAnterior').onclick = () => {
    mes--; if (mes < 1) { mes = 12; ano--; } carregarCalendario();
  };
  document.getElementById('mesProximo').onclick = () => {
    mes++; if (mes > 12) { mes = 1; ano++; } carregarCalendario();
  };

  function formatarData(iso) {
    try { const [a,m,d] = iso.split("-"); return `${d}/${m}/${a}`; }
    catch { return iso; }
  }

  async function carregarCalendario(){
    const hoje = new Date();
    const maxData = new Date();
    maxData.setMonth(maxData.getMonth() + 6);

    if (new Date(ano, mes - 1) > maxData) {
      calendario.innerHTML = "<p>üìÖ Reservas dispon√≠veis at√© 6 meses √† frente.</p>";
      return;
    }

    atualizarMesTitulo();
    calendario.innerHTML = "<p>Carregando...</p>";

    const url  = `/api/calendario/${encodeURIComponent(chaleSelecionado)}/${ano}/${mes}`;
    const resp = await fetch(url);
    if (!resp.ok) {
      calendario.innerHTML = "<p>Erro ao consultar disponibilidade.</p>";
      return;
    }

    const dias = await resp.json();
    diasGlobais = dias;

    const primeiroDia = (new Date(ano, mes-1, 1).getDay() + 6) % 7;
    const hojeISO = new Date().toISOString().split("T")[0];

    let html = `
      <div class="grid-header">
        <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sab</div><div>Dom</div>
      </div>
      <div class="grid">
    `;

    for (let i = 0; i < primeiroDia; i++) html += `<div class="vazio"></div>`;

    dias.forEach(diaInfo => {
      const dataObj = localDateFromISO(diaInfo.data);
      const diaNum  = dataObj.getDate();
      let classeDia = "dia";

      if (diaInfo.data < hojeISO) {
        classeDia += " passado";
      } else if (diaInfo.status === "ocupado") {
        classeDia += " vermelho";
      } else {
        classeDia += " verde";
      }

      const dow = dataObj.getDay();
      if (dow === 6 || dow === 0) classeDia += " fimsemana";

      const preco = diaInfo.valor ? `R$${diaInfo.valor}` : "";
      html += `<div class="${classeDia}" data-data="${diaInfo.data}" data-valor="${diaInfo.valor}">
                 ${diaNum}<br><small>${preco}</small>
               </div>`;
    });

    html += `</div>
      <div class="legenda">
        <span><div class="leg verde"></div>Dispon√≠vel</span>
        <span><div class="leg vermelho"></div>Ocupado</span>
        <span><div class="leg azul"></div>Selecionado</span>
      </div>`;

    calendario.innerHTML = html;

    document.querySelectorAll('.dia.verde').forEach(el => {
      el.addEventListener('click', () => selecionarData(el.dataset.data));
    });

    aplicarSelecaoVisual();
  }

  function selecionarData(data) {
    const hojeISO = new Date().toISOString().split("T")[0];
    if (data < hojeISO) return;

    const diaEl = document.querySelector(`.dia[data-data="${data}"]`);
    if (diaEl && (diaEl.classList.contains("vermelho") || diaEl.classList.contains("passado"))) {
      selecionado.innerHTML = "‚ùå Data indispon√≠vel para check-in ou check-out.";
      return;
    }

    if (!checkIn) {
      checkIn = data;
      checkOut = null;
      selecionado.innerHTML = "Selecione a data de check-out.";
    } else if (!checkOut) {
      if (new Date(data) <= new Date(checkIn)) {
        checkIn = data;
        checkOut = null;
        selecionado.innerHTML = "O check-out deve ser ap√≥s o check-in.";
      } else {
        const dias = Array.from(document.querySelectorAll(".dia"));
        const inicio = new Date(checkIn);
        const fim = new Date(data);
        let bloqueado = false;

        dias.forEach(dia => {
          const dt = new Date(dia.dataset.data);
          if (dt >= inicio && dt <= fim && dia.classList.contains("vermelho")) bloqueado = true;
        });

        if (bloqueado) {
          selecionado.innerHTML = "‚ùå H√° datas bloqueadas no per√≠odo.";
          checkIn = null;
          checkOut = null;
          aplicarSelecaoVisual();
          return;
        }

        checkOut = data;
        const intervalo = diasGlobais.filter(d => d.data >= checkIn && d.data < checkOut && d.status !== "ocupado");
        const total = intervalo.reduce((acc, d) => acc + (parseFloat(d.valor) || 0), 0);
        const totalDias = intervalo.length;

        const msg = `Ol√°! Gostaria de reservar o ${chaleSelecionado} de ${formatarData(checkIn)} at√© ${formatarData(checkOut)}.`;
        const link = `https://wa.me/5561999999999?text=${encodeURIComponent(msg)}`;

        selecionado.innerHTML = `
          <b>${totalDias} di√°rias - Total R$ ${total.toFixed(2).replace('.', ',')}</b><br>
          Check-in: ${formatarData(checkIn)}<br>
          Check-out: ${formatarData(checkOut)}<br>
          <a class="whats" href="${link}" target="_blank">Reservar pelo WhatsApp</a>`;
      }
    } else {
      checkIn = data;
      checkOut = null;
      selecionado.innerHTML = "Selecione a data de check-out.";
    }

    aplicarSelecaoVisual();
  }

  function aplicarSelecaoVisual() {
    document.querySelectorAll('.dia').forEach(d => d.classList.remove('checkin', 'checkout', 'range'));
    if (!checkIn) return;
    const ci = new Date(checkIn);
    const co = checkOut ? new Date(checkOut) : null;

    document.querySelectorAll('.dia.verde').forEach(el => {
      const dt = new Date(el.dataset.data);
      if (el.dataset.data === checkIn) el.classList.add('checkin');
      if (checkOut && el.dataset.data === checkOut) el.classList.add('checkout');
      if (co && dt > ci && dt < co) el.classList.add('range');
    });
  }

  carregarCalendario();
  </script>
</body>
</html>